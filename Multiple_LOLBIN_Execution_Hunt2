// Rule: L3_Universal_LOLBIN_Execution_Hunt_V5
// Purpose: Detect remote execution, file download, and credential/system configuration abuse via a wider set of LOLBINs.
// Data: DeviceProcessEvents
// MITRE: T1218 (Signed Binary Proxy Execution), T1105 (Ingress Tool Transfer), T1548 (Abuse Elevation Control)
// Author: Ala Dabat (Expanded by AI)

let lookback = 24h;

// --- EXPANDED TARGET PROCESSES ---
let TargetProcs = dynamic([
    "regsvr32.exe","mshta.exe","rundll32.exe","installutil.exe","regasm.exe","regsvcs.exe", // Original LOLBINs

    // New LOLBINs for Ingress/Execution:
    "certutil.exe", // Used for downloading/decoding payloads
    "bitsadmin.exe", // Used for downloading/transferring files
    "msiexec.exe", // Used for running installation files/scripts
    "forfiles.exe", // Used for executing commands across files
    "mavinject.exe", // Used for process injection

    // New LOLBINs for Discovery/Evasion:
    "taskmgr.exe", // Sometimes used to start suspicious processes
    "at.exe", "schtasks.exe", // Used for persistence/time-based execution
    "wmic.exe" // Used for discovery/lateral movement (added for completeness)
]);

let SuspiciousParents = dynamic(["cmd.exe","powershell.exe","pwsh.exe","wscript.exe","cscript.exe","winword.exe","excel.exe","outlook.exe"]);
let SuspiciousDirs = dynamic(["\\Users\\Public","\\ProgramData","\\Windows\\Temp","\\Temp","\\Downloads","\\AppData\\Local\\Temp","\\AppData\\Roaming"]);

DeviceProcessEvents
| where TimeGenerated > ago(lookback)
| where FileName in~ (TargetProcs)
| where ProcessCommandLine has_any ("http","ftp","scrobj","javascript","vbscript",".dll","/i","/u","Uninstallation", // Original Payload Keywords
                                     "download","decode","urlcache", // New keywords for downloaders (certutil, bitsadmin)
                                     "/r /t","create /tn" // New keywords for persistence (schtasks)
                                   )
| extend
    IsRundll32 = FileName =~ "rundll32.exe",
    HasNet = ProcessCommandLine matches regex @"(?i)(http[s]?://|ftp://)",
    HasScript = ProcessCommandLine has_any ("scrobj.dll","javascript:","vbscript:","wscript.shell"),
    BadDLLPath = ProcessCommandLine has ".dll" and ProcessCommandLine has_any (SuspiciousDirs),
    WeirdExport = IsRundll32 and ProcessCommandLine matches regex @"(?i),(#\d+|run|start|dllregisterserver|entry|main)",
    BadParent = InitiatingProcessFileName in~ (SuspiciousParents),

    // --- NEW BEHAVIORAL FLAGS ---
    IsDownloader = FileName in~ ("certutil.exe", "bitsadmin.exe") and ProcessCommandLine has_any ("download", "urlcache", "retrieve"),
    IsPersistence = FileName in~ ("schtasks.exe", "at.exe") and ProcessCommandLine has_any ("create", "/r /t")
| extend RiskScore =
    0
    // Increased score for network-related activity (download/remote execution)
    + iif(HasNet or IsDownloader, 60, 0)
    + iif(HasScript, 50, 0)
    
    // Core LOLBIN and DLL abuse
    + iif(BadDLLPath, 30, 0)
    + iif(WeirdExport, 20, 0)
    
    // High-Confidence Triggers
    + iif(BadParent, 20, 0) // Executed by a suspicious process
    + iif(IsPersistence, 40, 0) // Attempting to establish persistence
| where RiskScore >= 50
| extend Hunter_Directive = case(
    HasNet or IsDownloader, "CRITICAL: Remote File Download/Script Execution via LOLBIN",
    IsPersistence, "HIGH: LOLBIN used to establish Scheduled Task/Persistence",
    HasScript, "Remote/scriptlet execution",
    BadDLLPath or WeirdExport, "Local DLL loader from non-system path",
    "Suspicious LOLBIN activity"
)
| summarize Count=count(), MaxRisk=max(RiskScore), SampleCLI=any(ProcessCommandLine)
    by DeviceName, FileName, Hunter_Directive
| where not(Count > 20 and MaxRisk < 70) // Retain your noise suppression filter
