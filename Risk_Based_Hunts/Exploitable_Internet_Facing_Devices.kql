// ---------------------------------------------------------------------------
//   Internet-Facing Devices with Exploitable Vulnerabilities
//   Author: Ala Dabat
//    - Intersection of “IsInternetFacing” and “exploit available” TVM items.
//    - Very high-value patching and hardening target list.
// ---------------------------------------------------------------------------
;
let InternetFacingDevices =
    DeviceInfo
    | summarize arg_max(Timestamp, *) by DeviceId
    | where IsInternetFacing == true
    | distinct DeviceId;
let ExploitableKB =
    DeviceTvmSoftwareVulnerabilitiesKB
    | where IsExploitAvailable == 1
    | project CveId;
DeviceTvmSoftwareVulnerabilities
| where CveId in~ (ExploitableKB)
| where DeviceId in~ (InternetFacingDevices)
| summarize
    TotalExploitableVulnerabilities = dcount(CveId),
    CveIds = make_set(CveId),
    SoftwareNames = make_set(SoftwareName),
    RecommendedSecurityUpdates = make_set(RecommendedSecurityUpdate)
  by DeviceName
| sort by TotalExploitableVulnerabilities desc
