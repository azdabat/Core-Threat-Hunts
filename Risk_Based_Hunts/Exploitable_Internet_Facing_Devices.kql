// Internet-Facing Devices With Exploitable Vulnerabilities
// Option: Set ServerOnly = true to restrict to servers
// Author: Ala Dabat

let lookback = 30d;
let ServerOnly = false;

// Internet-facing devices
let InternetFacing =
DeviceInfo
| summarize arg_max(Timestamp, *) by DeviceId
| where IsInternetFacing == true
| extend IsServer = iff(DeviceType =~ "Server", true, false)
| where (ServerOnly == false) or (ServerOnly == true and IsServer == true)
| project DeviceId, DeviceName, DeviceType;

// Exploitable vulns
let Exploitable =
DeviceTvmSoftwareVulnerabilitiesKB
| where IsExploitAvailable == 1
| project CveId;

DeviceTvmSoftwareVulnerabilities
| where CveId in (Exploitable)
| where DeviceId in (InternetFacing)
| summarize
    TotalExploitable = dcount(CveId),
    CveIds = make_set(CveId),
    Softwares = make_set(SoftwareName),
    RecommendedUpdates = make_set(RecommendedSecurityUpdate)
  by DeviceName
| order by TotalExploitable desc
