// ---------------------------------------------------------------------------
//   TVM – Devices with Highest Exploitable Risk (Risk-Based Hunt)
//    Author: Ala Dabat
//    - Ranks devices by count of vulnerabilities where exploit is available.
//    - Use to prioritise patching & exposure reduction alongside threat hunts.
//    Tactics: TA0001 (Initial Access), TA0003 (Persistence) – Risk surface
// ---------------------------------------------------------------------------
// Highly Exploitable Devices (Recent CVEs + Server Option)

let timeframe = 30d;
let ServerOnly = false;

let Exploitable =
DeviceTvmSoftwareVulnerabilitiesKB
| where IsExploitAvailable == 1
| where PublishedDate > (now() - timeframe)
| project CveId;

let DeviceInventory =
DeviceInfo
| summarize arg_max(Timestamp, *) by DeviceId
| extend IsServer = iff(DeviceType =~ "Server", true, false)
| project DeviceId, DeviceName, DeviceType, IsServer;

DeviceTvmSoftwareVulnerabilities
| join kind=inner Exploitable on CveId
| join kind=leftouter DeviceInventory on DeviceId
| where (ServerOnly == false) or (ServerOnly == true and IsServer == true)
| summarize
    TotalExploitable = dcount(CveId),
    ExploitCves = make_set(CveId),
    SoftwareNames = make_set(SoftwareName)
  by DeviceName, DeviceType
| order by TotalExploitable desc
