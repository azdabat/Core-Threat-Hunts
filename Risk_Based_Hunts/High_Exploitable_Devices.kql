// ---------------------------------------------------------------------------
//   TVM – Devices with Highest Exploitable Risk (Risk-Based Hunt)
//    - Ranks devices by count of vulnerabilities where exploit is available.
//    - Use to prioritise patching & exposure reduction alongside threat hunts.
//    Tactics: TA0001 (Initial Access), TA0003 (Persistence) – Risk surface
// ---------------------------------------------------------------------------
;
let tvm_timeframe = 30d;
let ExploitableVulns =
    DeviceTvmSoftwareVulnerabilitiesKB
    | where IsExploitAvailable == 1
    | where PublishedDate > (now() - tvm_timeframe)
    | project CveId;
DeviceTvmSoftwareVulnerabilities
| where CveId in~ (ExploitableVulns)
| summarize
    TotalExploitableVulnerabilities = dcount(CveId),
    ExploitableCVE = make_set(CveId),
    SoftwareNames = make_set(SoftwareName)
  by DeviceName
| top 20 by TotalExploitableVulnerabilities desc
