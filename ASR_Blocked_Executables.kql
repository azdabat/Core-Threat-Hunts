// ---------------------------------------------------------------------------
// ASR HUNT: Blocked / Audited Untrusted Executables (Enhanced)
// Author: Ala Dabat
// Focus: Low-prevalence binaries stopped by ASR Rule "Block executable files..."
// ---------------------------------------------------------------------------

let Lookback = 30d;

DeviceEvents
// ---------------------------------------------------------------------------
// SECTION 1: EVENT SCOPE
// ---------------------------------------------------------------------------
| where Timestamp >= ago(Lookback)
| where ActionType in ("AsrUntrustedExecutableAudited", "AsrUntrustedExecutableBlocked")

// ---------------------------------------------------------------------------
// SECTION 2: NOISE REDUCTION & AGGREGATION
// ---------------------------------------------------------------------------
| summarize 
    FirstSeen       = min(Timestamp),
    LastSeen        = max(Timestamp),
    LocalPrevalence = dcount(DeviceId), // How many machines in YOUR org have this?
    DeviceList      = make_set(DeviceName, 5), // Sample of affected devices
    ActionTypes     = make_set(ActionType), // Was it Blocked, Audited, or both?
    LaunchParents   = make_set(InitiatingProcessFileName, 5) // Who launched it?
    by SHA1, FileName, FolderPath

// ---------------------------------------------------------------------------
// SECTION 3: RARITY FILTER (The "Hunting" Logic)
// ---------------------------------------------------------------------------
| where LocalPrevalence <= 5  // Only show things rare in our environment
| where LastSeen >= ago(24h)  // Focus on recent activity

// ---------------------------------------------------------------------------
// SECTION 4: ENRICHMENT (Global Context)
// ---------------------------------------------------------------------------
| invoke FileProfile(SHA1, 1000) 
| join kind=leftouter (
    DeviceFileCertificateInfo
    | where Timestamp >= ago(Lookback)
    | summarize arg_max(Timestamp, SignerName=Signer, IssuerName=Issuer) by SHA1
) on SHA1

// ---------------------------------------------------------------------------
// SECTION 5: HUNTER'S VIEW (Output)
// ---------------------------------------------------------------------------
| project 
    LastSeen,
    ActionTypes,
    FileName,
    FolderPath,
    LaunchParents,      // Critical context: Did 'explorer.exe' launch it or 'powershell.exe'?
    LocalPrevalence,
    GlobalPrevalence,   // From FileProfile: Is it rare globally?
    SignerName,         // From CertInfo: Who signed it?
    IssuerName,
    ThreatName,         // From FileProfile: Does Microsoft already know it's bad?
    SoftwareName,
    SHA1,
    DeviceList
| order by LastSeen desc
