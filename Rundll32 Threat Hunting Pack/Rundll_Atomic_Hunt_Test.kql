// ============================================================================
// L3 RUNDLL32 HUNTING RULE - Rule Optomization in process
// ============================================================================

let lookback = 30d; // 

// --- STEP 1: SCHEMA NORMALIZATION ---
let GetProcessEvents = () { 
    DeviceProcessEvents 
    | where Timestamp >= ago(lookback)
    | extend TimeGenerated = todatetime(column_ifexists("TimeGenerated", column_ifexists("Timestamp", now())))
};
let GetNetworkEvents = () { 
    DeviceNetworkEvents 
    | where Timestamp >= ago(lookback)
    | extend TimeGenerated = todatetime(column_ifexists("TimeGenerated", column_ifexists("Timestamp", now())))
};
let GetFileEvents = () { 
    DeviceFileEvents 
    | where Timestamp >= ago(lookback)
    | extend TimeGenerated = todatetime(column_ifexists("TimeGenerated", column_ifexists("Timestamp", now())))
};

// --- STEP 2: CONFIGURATION (Unchanged) ---
let LegitParents = dynamic(["explorer.exe","svchost.exe","services.exe","winlogon.exe","userinit.exe","dwm.exe"]);
let OfficeParents = dynamic(["winword.exe","excel.exe","powerpnt.exe","outlook.exe"]);
let ScriptParents = dynamic(["powershell.exe","pwsh.exe","cmd.exe","wscript.exe","cscript.exe","mshta.exe","wmic.exe","wmiprvse.exe"]);
let LegitRundll32CmdAllow = dynamic([
  "rundll32.exe shell32.dll,control_rundll", "rundll32.exe shell32.dll,control_rundll desk.cpl",
  "rundll32.exe shell32.dll,control_rundll main.cpl", "rundll32.exe user32.dll,lockworkstation", "rundll32.exe printui.dll,printuientry"
]);
let AbusedDlls = dynamic(["comsvcs.dll","advpack.dll","ieadvpack.dll","syssetup.dll","setupapi.dll","pcwutl.dll","dfshim.dll","url.dll","shdocvw.dll","mshtml.dll","scrobj.dll","crypt32.dll","shell32.dll"]);
let SuspiciousDirs = dynamic(["\\windows\\temp\\","\\users\\public\\","\\appdata\\local\\temp\\","\\programdata\\"]);
let SuspiciousExts = dynamic([".sct",".vbs",".js",".jse",".vbe",".inf",".ins",".isp"]);

// --- STEP 3: BASE EVENT SELECTION (Unchanged) ---
let RundllExecutions =
    GetProcessEvents()
    | where FileName =~ "rundll32.exe"
    | extend CommandLine = tostring(ProcessCommandLine)
    | extend CommandLower = tolower(CommandLine)
    | extend ParentProcess = tostring(InitiatingProcessFileName)
    | extend ParentLower = tolower(ParentProcess)
    | where not(CommandLower has_any (LegitRundll32CmdAllow))
    | extend
        Flag_ScriptProtocol = CommandLower has_any ("javascript:","vbscript:","mshtml,runhtmlapplication","mshtml.dll","scrobj.dll"),
        Flag_Ordinal = CommandLine matches regex @",\s*#[0-9]+",
        Flag_Remote = (CommandLower startswith "\\\\") or (CommandLower has_any ("http://","https://","ftp://")),
        Flag_AbusedDll = CommandLower has_any (AbusedDlls),
        Flag_LsassDump = CommandLower has_any ("comsvcs","minidump"),
        Flag_InfInstall = CommandLower has_any ("advpack","ieadvpack","syssetup","setupapi","registerocx","launchinfsection","setupinfobjectinstallaction"),
        Flag_ControlRunDLL = CommandLower has "control_rundll",
        Flag_ControlNotCpl = (CommandLower has "control_rundll") and (CommandLower !has ".cpl"),
        Flag_EnvVar = CommandLine matches regex @"%\w+%.*(\.dll|\.cpl|\.sct|\.js|\.vbs)",
        Flag_PathObfus = (CommandLower has "progra~1") or (CommandLower has "windows~1") or (CommandLine matches regex @"rundll32\.exe.*\.\.\\"),
        Flag_DoubleExt = (CommandLine matches regex @"\.(pdf|doc|docx|jpg|png|txt)\.(dll|exe)"),
        Flag_SuspDir = CommandLower has_any (SuspiciousDirs),
        Flag_SuspExt = CommandLower has_any (SuspiciousExts),
        Flag_BadParent = (ParentLower !in~ (LegitParents)) and (ParentLower in~ (OfficeParents) or ParentLower in~ (ScriptParents) or ParentLower in~ ("chrome.exe","msedge.exe","firefox.exe","w3wp.exe","sqlservr.exe"))
    | extend Category = case(
        Flag_ScriptProtocol, "Script_Protocol_Handler_Abuse",
        Flag_LsassDump,      "LSASS_Dump_via_comsvcs",
        Flag_InfInstall,     "INF_Install_ProxyExec",
        Flag_Remote,         "Remote_WebDAV_UNC_Load",
        Flag_Ordinal,        "Ordinal_Execution_Obfuscation",
        Flag_ControlNotCpl,  "Control_RunDLL_Misuse",
        Flag_AbusedDll,      "Known_Abused_DLL_ProxyExec",
        Flag_DoubleExt,      "Double_Extension_Masquerade",
        Flag_EnvVar,         "EnvVar_Obfuscation",
        Flag_PathObfus,      "Path_Obfuscation",
        Flag_SuspExt,        "Suspicious_Script_Extension",
        Flag_SuspDir,        "Suspicious_Directory_Context",
        Flag_BadParent,      "Anomalous_Parentage",
        "Other"
    )
    | where Category != "Other"
    // OPTIMIZATION: Simplified regex for performance
    | extend CmdNorm = replace_regex(CommandLower, @"\b\d+\b", "<num>")
    | extend CmdHash = hash_sha256(CmdNorm);

// --- STEP 4: PREPARE CONTEXT TABLES (Optimized) ---
let CommandPrevalence =
    RundllExecutions
    | summarize CmdPrevalence = dcount(DeviceId) by CmdHash;

// OPTIMIZATION: Pre-summarize network events to avoid 1:N join explosion
let NetworkContext =
    GetNetworkEvents()
    | where InitiatingProcessFileName =~ "rundll32.exe"
    | where RemoteIP !startswith "127." and RemoteIP != "::1"
    | project DeviceId, NetTime=TimeGenerated, RemoteIP
    | summarize NetNearList = make_list(pack("Time", NetTime, "IP", RemoteIP)) by DeviceId;

// OPTIMIZATION: Pre-summarize file events
let DllDrops =
    GetFileEvents()
    | where ActionType in ("FileCreated","FileRenamed","FileModified")
    | where FileName endswith ".dll" or FileName endswith ".exe"
    | where tolower(FolderPath) has_any (SuspiciousDirs) or FolderPath has "Temp"
    | project DeviceId, FileTime=TimeGenerated, DroppedDll=strcat(FolderPath,"\\",FileName)
    | summarize DllNearList = make_list(pack("Time", FileTime, "File", DroppedDll)) by DeviceId;

// OPTIMIZATION: Pre-summarize child processes
let ChildShells =
    GetProcessEvents()
    | where InitiatingProcessFileName =~ "rundll32.exe"
    | where FileName in~ ("cmd.exe","powershell.exe","pwsh.exe")
    | project DeviceId, ChildTime=TimeGenerated, ChildProcess=FileName
    | summarize ChildNearList = make_list(pack("Time", ChildTime, "Proc", ChildProcess)) by DeviceId;

// --- STEP 5: JOIN & SCORE (Optimized Logic) ---
RundllExecutions
| join kind=leftouter CommandPrevalence on CmdHash
| extend CmdPrevalence = coalesce(CmdPrevalence, 1)
| join kind=leftouter NetworkContext on DeviceId
| join kind=leftouter DllDrops on DeviceId
| join kind=leftouter ChildShells on DeviceId
// CALCULATE PROXIMITY POST-AGGREGATION (Much faster)
| extend 
    NetNear = mv-apply x = NetNearList to typeof(dynamic) on ( where abs(datetime_diff("minute", TimeGenerated, todatetime(x.Time))) <= 5 | take 1 | project Exists=true ),
    DllNear = mv-apply x = DllNearList to typeof(dynamic) on ( where abs(datetime_diff("minute", TimeGenerated, todatetime(x.Time))) <= 10 | take 1 | project Exists=true ),
    ChildShellNear = mv-apply x = ChildNearList to typeof(dynamic) on ( where abs(datetime_diff("minute", TimeGenerated, todatetime(x.Time))) <= 5 | take 1 | project Exists=true )
| extend NetNear = coalesce(NetNear, false), DllNear = coalesce(DllNear, false), ChildShellNear = coalesce(ChildShellNear, false)
| extend
    BaseScore = case(
        Category == "Script_Protocol_Handler_Abuse", 85,
        Category == "LSASS_Dump_via_comsvcs", 85,
        Category == "INF_Install_ProxyExec", 75,
        Category == "Remote_WebDAV_UNC_Load", 70,
        Category == "Control_RunDLL_Misuse", 65,
        Category == "Ordinal_Execution_Obfuscation", 60,
        Category == "Known_Abused_DLL_ProxyExec", 55,
        Category == "Double_Extension_Masquerade", 55,
        Category == "EnvVar_Obfuscation", 45,
        Category == "Path_Obfuscation", 45,
        Category == "Suspicious_Script_Extension", 55,
        Category == "Suspicious_Directory_Context", 35,
        Category == "Anomalous_Parentage", 45,
        30
    ),
    ContextScore =
        (20 * iff(Flag_BadParent, 1, 0))
      + (15 * iff(NetNear, 1, 0))
      + (15 * iff(DllNear, 1, 0))
      + (30 * iff(ChildShellNear, 1, 0))
      + (10 * iff(Flag_SuspDir, 1, 0))
      + (10 * iff(Flag_SuspExt, 1, 0)),
    RarityScore = case(
      CmdPrevalence <= 1, 20,
      CmdPrevalence <= 3, 12,
      CmdPrevalence <= 10, 6,
      -8
    )
| extend FinalScore = tolong(BaseScore + ContextScore + RarityScore)
| extend Severity = case(
    FinalScore >= 95, "CRITICAL",
    FinalScore >= 75, "HIGH",
    FinalScore >= 55, "MEDIUM",
    "LOW"
)
// --- STEP 6: OUTPUT ---
| where Severity != "LOW"
| where
    Category in ("Script_Protocol_Handler_Abuse","LSASS_Dump_via_comsvcs","INF_Install_ProxyExec","Remote_WebDAV_UNC_Load")
    or (Category in ("Control_RunDLL_Misuse","Ordinal_Execution_Obfuscation","Known_Abused_DLL_ProxyExec","Double_Extension_Masquerade","Suspicious_Script_Extension")
        and (NetNear or DllNear or Flag_BadParent or ChildShellNear))
    or (Category in ("EnvVar_Obfuscation","Path_Obfuscation","Suspicious_Directory_Context","Anomalous_Parentage")
        and (NetNear or DllNear or ChildShellNear)
        and CmdPrevalence <= 3)
| project TimeGenerated, Category, FinalScore, Severity, CommandLine, ChildShellNear, NetNear, DllNear, CmdPrevalence, DeviceId
| order by FinalScore desc
