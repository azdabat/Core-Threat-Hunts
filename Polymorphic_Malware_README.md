# Polymorphic Loader Detection – Core Rule Test & Evaluation Module
Ala Dabat  
Senior SOC / Incident Response / Detection Engineering

This module evaluates the Core Polymorphic Loader Detection Rule against realistic loader behaviours observed in modern polymorphic malware families. It includes the rule, coverage matrices, behavioural alignment, and simulated threat-hunter outputs formatted for practical SOC use.

---

# 1. Core Polymorphic Loader Detection Rule (Tier 1/2 Version)

```kql
//  Polymorphic Loader Detection (With Hunter Directives)
//  Author: Ala Dabat

let lookback = 3d;

// Writable location profiles
let suspicious_folders = dynamic(["C:\\ProgramData\\","C:\\Users\\","C:\\Temp\\","C:\\Windows\\Temp\\"]);

// High-risk loader processes (LOLBins frequently used for execution / loading)
let lolbins = dynamic(["rundll32.exe","regsvr32.exe","mshta.exe","powershell.exe","wscript.exe","cscript.exe","cmd.exe"]);

// 1. File drops into suspicious folders
let drops =
DeviceFileEvents
| where Timestamp >= ago(lookback)
| extend FileExt = tolower(split(FileName,".",-1)[-1])
| where FileExt in ("dll","exe","sys")
| where FolderPath has_any (suspicious_folders)
| project DeviceId,DeviceName,
          DropTime=Timestamp,
          DroppedFile=FileName,
          DroppedPath=FolderPath,
          DroppingProcessName=InitiatingProcessFileName,
          DroppingProcessId=InitiatingProcessId;

// 2. Unsigned suspicious DLL/SYS loads
let loads =
DeviceImageLoadEvents
| where Timestamp >= ago(lookback)
| extend FileExt = tolower(split(FileName,".",-1)[-1])
| where FileExt in ("dll","sys")
| where SignatureStatus in ("Unsigned","Invalid","Unknown")
| project DeviceId,DeviceName,
          LoadTime=Timestamp,
          LoadedFile=FileName,
          LoaderProcessName=InitiatingProcessFileName,
          LoaderProcessId=InitiatingProcessId;

// 3. Outbound C2 attempts
let net =
DeviceNetworkEvents
| where Timestamp >= ago(lookback)
| where ActionType == "ConnectionSuccess"
| project DeviceId,DeviceName,
          ProcessId,
          ConnectionTime=Timestamp,
          RemoteIP,RemoteUrl,RemotePort;

// 4. Join drop → load → C2 correlation
drops
| join kind=leftouter loads on DeviceId,DeviceName, DroppedFile == LoadedFile
| join kind=leftouter net on DeviceId, ProcessId
| extend LoadDelay = iff(isnotempty(LoadTime), toint((LoadTime - DropTime)/1m), int(null))
| extend C2Delay   = iff(isnotempty(ConnectionTime), toint((ConnectionTime - DropTime)/1s), int(null))

// Behaviour flags
| extend FastLoad        = iif(isnotempty(LoadTime) and LoadDelay between (0 .. 5), 1, 0)
| extend FastC2          = iif(isnotempty(ConnectionTime) and C2Delay between (0 .. 60), 1, 0)
| extend LoaderIsLOLBIN  = iif(LoaderProcessName in~ (lolbins), 1, 0)
| extend DropperIsLOLBIN = iif(DroppingProcessName in~ (lolbins), 1, 0)

// Scoring model
| extend Score =
      FastLoad*3 +
      FastC2*3 +
      LoaderIsLOLBIN*2 +
      DropperIsLOLBIN*2

// Severity
| extend Severity =
  case(
    Score >= 8,  "High",
    Score between (5 .. 7), "Medium",
    Score between (3 .. 4), "Low",
    "Informational"
  )

// Hunter directives
| extend HunterDirectives =
  case(
    Severity == "High" and FastC2 == 1 and FastLoad == 1,
      "Correlate full process chain. Investigate remote endpoint. Isolate if behaviour persists. Search fleet for same dropper and DLL.",
    Severity == "High" and FastLoad == 1,
      "Inspect loader process. Verify signer. Assess for sideloading or tampering.",
    Severity == "Medium" and FastC2 == 1,
      "Review C2 target. Validate if loader behaviour is expected. Check for encoded scripts.",
    Severity == "Medium" and (DropperIsLOLBIN == 1 or LoaderIsLOLBIN == 1),
      "Determine if LOLBin use is legitimate in context. Review recent scripts or admin activity.",
    Severity == "Low",
      "Use as a hunting lead. Validate against known software updaters. Add exclusions as needed.",
    "Review context before triage."
  )

| where Score >= 3

| project
    Timestamp = coalesce(LoadTime, DropTime, ConnectionTime),
    DeviceName,
    Severity,
    Score,
    HunterDirectives,
    DroppedFile,
    DroppedPath,
    DroppingProcessName,
    LoaderProcessName,
    RemoteIP,
    RemoteUrl,
    FastLoad,
    FastC2,
    LoaderIsLOLBIN,
    DropperIsLOLBIN

| order by Timestamp desc

```
```
+---------------------------------------------------------------+----------+--------------------------------------------------------------+
| Behaviour Pattern                                             | Detected | Reason                                                       |
+---------------------------------------------------------------+----------+--------------------------------------------------------------+
| DLL/EXE/SYS drop in writable path                             |   YES    | Rule anchors on DeviceFileEvents under ProgramData/Temp/etc. |
| Fast DLL/SYS load (0–5 min after drop)                        |   YES    | FastLoad scoring logic                                       |
| Fast C2 (0–60s after drop)                                    |   YES    | FastC2 scoring logic                                         |
| LOLBin loader chain (rundll32/mshta/pwsh/etc.)                |   YES    | LoaderIsLOLBIN/DropperIsLOLBIN flags                         |
| Unsigned DLL/SYS load                                         |   YES    | Joined via DeviceImageLoadEvents                             |
| Polymorphic EXE loader                                        | PARTIAL  | Scored via FastC2 + LOLBin dropper                           |
| Supply-chain sideloading from ProgramData                     |   YES    | Writable path + DLL load                                     |
| Supply-chain sideloading from Program Files                   |    NO    | Not in suspicious_folders                                    |
| BYOVD driver drop (.sys)                                      | PARTIAL  | Only scores if fast load or fast C2 occurs                   |
| Slow C2 (beacon after >60s)                                   |    NO    | Out-of-scope for core rule                                   |
| Slow DLL load (>5 minutes)                                    |    NO    | Out-of-scope for this rule                                   |
| Fileless loader (no disk writes)                              |    NO    | Companion rule covers this                                    |
| Self-delete (drop → load → delete)                            |    NO    | L3 Extended Rule only                                        |
| Dormant driver/DLL behaviour                                  |    NO    | L3 Extended Rule only                                        |
+---------------------------------------------------------------+----------+--------------------------------------------------------------+
```
```
+------+-----------------------------------------------------------+----------+--------+----------------+------------------+--------+----------+-----------+
| ID   | Behaviour Description                                     | FastLoad | FastC2 | LoaderIsLOLBIN | DropperIsLOLBIN  | Score  | Severity | Detected  |
+------+-----------------------------------------------------------+----------+--------+----------------+------------------+--------+----------+-----------+
| P1   | Word macro → DLL drop → rundll32 load → C2 in 20s        |    1     |   1    |       1        |        1         |  10    |  High    |   YES     |
| P2   | Outlook → pwsh → EXE drop → instant C2                   |    0     |   1    |       0        |        1         |   5    | Medium   |   YES     |
| P3   | DLL drop → rundll32 load, no immediate C2                |    1     |   0    |       1        |        0         |   5    | Medium   |   YES     |
| P4   | Unsigned .sys dropped dormant, no load                   |    0     |   0    |       0        |        0         |   0    |   N/A    |    NO     |
| P5   | EXE dropped to Temp, fast C2, no LOLBins                 |    0     |   1    |       0        |        0         |   3    |   Low    |   YES     |
| P6   | Sideloading from Program Files directory                 |    0     |   0    |       1        |        0         |   2    |   N/A    |    NO     |
| P7   | Fileless encoded PS → in-memory load → fast C2           |    0     |   1    |       1        |        1         |   7    | Medium*  |   NO*     |
| P8   | Installer: DLL drop → fast load → vendor CDN C2          |    1     |   1    |       0        |        0         |   6    | Medium   |   YES     |
+------+-----------------------------------------------------------+----------+--------+----------------+------------------+--------+----------+-----------+

```

Timestamp:        2025-12-03T10:14:32Z
DeviceName:       HR-LAPTOP-021
Severity:         High
Score:            10
HunterDirectives: Correlate full process chain. Investigate remote endpoint. Isolate if behaviour persists.
DroppedFile:          loader.dll
DroppedPath:          C:\ProgramData\Acme\loader.dll
DroppingProcessName:  WINWORD.EXE
LoaderProcessName:    rundll32.exe
RemoteIP:             198.51.100.42
RemoteUrl:            https://cdn.update-secure[.]com/payload.bin
FastLoad:             1
FastC2:               1
LoaderIsLOLBIN:       1
DropperIsLOLBIN:      0


