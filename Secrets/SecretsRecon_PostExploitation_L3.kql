# ==============================================
# SecretsRecon_PostExploitation_L3.kql
# LOCATION: /Secrets/SecretsRecon_PostExploitation_L3.kql
# PURPOSE: Detect access to sensitive secrets post-web exploitation
# MITRE: T1552 (Credentials in Files), T1003 (Credential Access)
# Gemini Enhancement: Suppress known legitimate readers (git, ssh, dev tools)
# ==============================================

let Lookback = 72h;

let SensitiveFiles = dynamic([".env","id_rsa","id_ed25519","credentials","aws","gcloud"]);
let AllowedReaders = dynamic(["git.exe","ssh.exe","code.exe","terraform.exe"]);

DeviceFileEvents
| where Timestamp >= ago(Lookback)
| where FileName has_any (SensitiveFiles)
| where InitiatingProcessFileName !in~ (AllowedReaders)
| project Timestamp, DeviceName, InitiatingProcessFileName, FileName, FolderPath
| extend Severity = "High â€“ Secrets Accessed", 
    HunterDirective = strcat("Check whether ", InitiatingProcessFileName,
                             " is expected to read secrets. Validate developer vs. server role."),
    MITRE = "T1552"
| order by Timestamp desc
