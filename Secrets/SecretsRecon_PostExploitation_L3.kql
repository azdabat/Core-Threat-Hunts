# ==============================================
# SecretsRecon_PostExploitation_L3.kql
# LOCATION: /Secrets/SecretsRecon_PostExploitation_L3.kql
# PURPOSE: Detect access to sensitive secrets post-web exploitation
# MITRE: T1552 (Credentials in Files), T1003 (Credential Access)
#  Suppress known legitimate readers (git, ssh, dev tools)
# ==============================================
let Lookback = 72h;

// Expanded list of sensitive files (includes common credential files and configuration files)
let SensitiveFiles = dynamic([
    // SSH/Crypto Keys
    "id_rsa", "id_dsa", "id_ed25519", "known_hosts", "authorized_keys",
    // Cloud Credentials
    "credentials", "aws", "gcloud", "azure", "serviceAccountKey",
    // Configuration/Secrets
    ".env", ".npmrc", ".gitconfig", ".kube/config", "config.json",
    // Generic Secrets
    "secret.txt", "key.pem", "vault"
]);

// Processes that are always expected to read these files (LOW RISK / SUPPRESS)
let AllowedReaders = dynamic([
    "git.exe", "ssh.exe", "code.exe", "terraform.exe", "cmd.exe",
    "powershell.exe", "pwsh.exe", "bash.exe", "explorer.exe", "wsl.exe"
]);

// Processes often abused by attackers to read files (HIGH RISK SIGNAL)
let SuspiciousReaders = dynamic([
    "find.exe", "findstr.exe", "grep.exe", "more.exe", "type.exe", "rar.exe", "7z.exe", // Search/Archive tools
    "curl.exe", "wget.exe", "bitsadmin.exe", // Exfiltration tools
    "wmic.exe", "certutil.exe" // General purpose Windows utilities
]);


DeviceFileEvents
| where Timestamp >= ago(Lookback)
| where ActionType in ("FileRead", "FileAccessed", "FileModified") // Focus on reading/access
| where FileName has_any (SensitiveFiles)
| where InitiatingProcessFileName !in~ (AllowedReaders) // Suppress known benign activity
| extend
    IsSuspiciousProcess = InitiatingProcessFileName in~ (SuspiciousReaders),
    IsNewProcess = Timestamp > ago(1h) // Use a 1-hour window for process novelty
| extend RiskScore =
    0
    + iif(IsSuspiciousProcess, 50, 0) // Highly suspicious reader (findstr, certutil, etc.)
    + iif(IsNewProcess, 20, 0) // Process is new/fresh (could be a dropped tool)
    + iif(FolderPath contains "temp" or FolderPath contains "public", 10, 0) // Context check: reading from public/temp folders
| where RiskScore >= 50 // Only show high-confidence alerts
| extend HunterDirective = case(
    IsSuspiciousProcess and (IsNewProcess or FolderPath contains "temp"),
        "CRITICAL: Search/Archive/Exfiltration tool accessed sensitive secrets. Immediately check process tree and network connections for egress.",
    IsSuspiciousProcess,
        "HIGH: Recognized attacker LOLBIN accessed sensitive file. Review full command line for exfiltration commands (base64, remote C2).",
    "MEDIUM: Unauthorised application accessed secrets. Validate application legitimacy and account compromise status."
)
| summarize
    Count=count(),
    MaxRisk=max(RiskScore),
    SampleCLI=any(InitiatingProcessCommandLine)
    by DeviceName, FileName, InitiatingProcessFileName, HunterDirective
| order by MaxRisk desc, Count desc
