//  Polymorphic Loader Detection (With Hunter Directives)
// Author: Ala Dabat
// Purpose: Compact behavioural analytic for detecting polymorphic loaders that drop DLL/EXE/SYS into writable paths,
//          load them rapidly, establish fast outbound connections, or execute via LOLBins.
// Suitable for: Tier 1/2 alerting, baseline threat-hunting packs, and lightweight behavioural correlation.
// For full engineering pack see Advanced Threat Hunting section and companion Fileless rule: Tune accordingly

let lookback = 3d;

// Writable location profiles
let suspicious_folders = dynamic(["C:\\ProgramData\\","C:\\Users\\","C:\\Temp\\","C:\\Windows\\Temp\\"]);

// High-risk loader processes (LOLBins frequently used for execution / loading)
let lolbins = dynamic(["rundll32.exe","regsvr32.exe","mshta.exe","powershell.exe","wscript.exe","cscript.exe","cmd.exe"]);

// -----------------------------------------------------------
// 1. File drop surface
// -----------------------------------------------------------
let drops =
DeviceFileEvents
| where Timestamp >= ago(lookback)
| extend FileExt = tolower(split(FileName,".",-1)[-1])
| where FileExt in ("dll","exe","sys")
| where FolderPath has_any (suspicious_folders)
| project DeviceId,DeviceName,
          DropTime=Timestamp,
          DroppedFile=FileName,
          DroppedPath=FolderPath,
          DroppingProcessName=InitiatingProcessFileName,
          DroppingProcessId=InitiatingProcessId;

// -----------------------------------------------------------
// 2. Suspicious image loads (unsigned DLL/SYS loads)
// -----------------------------------------------------------
let loads =
DeviceImageLoadEvents
| where Timestamp >= ago(lookback)
| extend FileExt = tolower(split(FileName,".",-1)[-1])
| where FileExt in ("dll","sys")
| where SignatureStatus in ("Unsigned","Invalid","Unknown")
| project DeviceId,DeviceName,
          LoadTime=Timestamp,
          LoadedFile=FileName,
          LoaderProcessName=InitiatingProcessFileName,
          LoaderProcessId=InitiatingProcessId;

// -----------------------------------------------------------
// 3. Fast outbound connections (C2 indicators)
// -----------------------------------------------------------
let net =
DeviceNetworkEvents
| where Timestamp >= ago(lookback)
| where ActionType == "ConnectionSuccess"
| project DeviceId,DeviceName,
          ConnectionTime=Timestamp,
          ProcessId,
          RemoteIP,
          RemoteUrl,
          RemotePort;

// -----------------------------------------------------------
// 4. Join drop → load → network for behavioural correlation
// -----------------------------------------------------------
drops
| join kind=leftouter loads on DeviceId,DeviceName, DroppedFile == LoadedFile
| join kind=leftouter net on DeviceId, ProcessId
| extend LoadDelay = iff(isnotempty(LoadTime), toint((LoadTime - DropTime)/1m), int(null))
| extend C2Delay   = iff(isnotempty(ConnectionTime), toint((ConnectionTime - DropTime)/1s), int(null))

// Behaviour flags
| extend FastLoad = iif(isnotempty(LoadTime) and LoadDelay between (0 .. 5), 1, 0)
| extend FastC2   = iif(isnotempty(ConnectionTime) and C2Delay between (0 .. 60), 1, 0)
| extend LoaderIsLOLBIN = iif(LoaderProcessName in~ (lolbins), 1, 0)
| extend DropperIsLOLBIN = iif(DroppingProcessName in~ (lolbins), 1, 0)

// Scoring model (small, stable, T1/T2 friendly)
| extend Score =
      FastLoad*3 +
      FastC2*3 +
      LoaderIsLOLBIN*2 +
      DropperIsLOLBIN*2

// Severity classification
| extend Severity =
  case(
    Score >= 8,  "High",
    Score between (5 .. 7), "Medium",
    Score between (3 .. 4), "Low",
    "Informational"
  )

// Hunter directives based on behaviour and severity
| extend HunterDirectives =
  case(
    Severity == "High" and FastC2 == 1 and FastLoad == 1,
      "Correlate process tree for the dropper and loader. Investigate remote endpoint. Isolate the host if behaviour persists. Check for additional DLL/SYS artifacts in writable locations. Search fleet for same DroppingProcessName and DroppedFile.",
    Severity == "High" and FastLoad == 1,
      "Inspect loading process for unexpected DLL activity. Verify signer and location. Review for supply-chain or sideloading patterns. Pivot across environment for same DLL filename or loader chain.",
    Severity == "Medium" and FastC2 == 1,
      "Review C2 destination. Determine whether loader process is legitimate. Check for encoded commands or further process activity on the host.",
    Severity == "Medium" and (DropperIsLOLBIN == 1 or LoaderIsLOLBIN == 1),
      "Validate whether LOLBin usage is expected. Review recent admin activity, scripts, or automation on host.",
    Severity == "Low",
      "Use as hunting lead. Validate against legitimate software updaters. Tune by excluding known deployment and patch management tools.",
    "Review contextual alerts and decide whether follow-up triage is required."
  )

// Minimum threshold for T1/T2 signal
| where Score >= 3

| project
    Timestamp = coalesce(LoadTime, DropTime, ConnectionTime),
    DeviceName,
    Severity,
    Score,
    HunterDirectives,
    DroppedFile,
    DroppedPath,
    DroppingProcessName,
    LoaderProcessName,
    RemoteIP,
    RemoteUrl,
    FastLoad,
    FastC2,
    LoaderIsLOLBIN,
    DropperIsLOLBIN

| order by Timestamp desc
