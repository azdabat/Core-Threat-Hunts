// =====================================================================================
// INTERNET-FACING DEVICES WITH EXPLOITABLE CVEs 
// Author: Ala Dabat
// Purpose: Identify externally exposed machines with known exploitable vulnerabilities
// =====================================================================================

// Identify externally-facing devices
let InternetFacingDevices =
    DeviceInfo
    | where IsInternetFacing == true and DeviceName !contains "DMZ"
    | summarize arg_max(Timestamp, *) by DeviceId
    | project DeviceId, DeviceName, OSPlatform, OSBuild, IsAzureADJoined;

// Exploitable CVE metadata
let ExploitableKB =
    DeviceTvmSoftwareVulnerabilitiesKB
    | where IsExploitAvailable == true
    | project CveId, CvssScore, VulnerabilitySeverityLevel,
              PublishedDate, LastModifiedTime,
              VulnerabilityDescription, AffectedSoftware;

// Join CVEs to internet-facing devices
DeviceTvmSoftwareVulnerabilities
| join kind=inner InternetFacingDevices on DeviceId
| join kind=inner ExploitableKB on CveId
| extend CVE_CVSS = strcat(CveId, " (CVSS ", tostring(CvssScore), ")")
| summarize
      CVE_List                   = make_list(CVE_CVSS),
      TotalExploitableCVEs       = dcount(CveId),
      Software_List              = make_set(SoftwareName),
      Required_Updates           = make_set(RecommendedSecurityUpdate),
      Severity_Levels            = make_set(VulnerabilitySeverityLevel),
      Vulnerability_Descriptions = make_set(VulnerabilityDescription),
      Avg_CVSS = avg(CvssScore),
      Max_CVSS = max(CvssScore)
      by DeviceName, OSPlatform, OSBuild, IsAzureADJoined
| extend RiskLevel = case(
      Avg_CVSS >= 9.0, "Critical",
      Avg_CVSS >= 7.0, "High",
      Avg_CVSS >= 4.0, "Medium",
      Avg_CVSS >  0.0, "Low",
      "Unrated")
| project RiskLevel, DeviceName, OSPlatform, OSBuild, IsAzureADJoined,
          TotalExploitableCVEs, Avg_CVSS, Max_CVSS,
          CVE_List, Software_List, Required_Updates, Severity_Levels,
          Vulnerability_Descriptions
| sort by TotalExploitableCVEs desc, Max_CVSS desc
