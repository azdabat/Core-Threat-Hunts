// ============================================================================
// Hunt Name: L2_Core_Polymorphic_Loader_Hunt
// Author: Ala Dabat
// WORK IN PROGRESS (untested)
// Type: Threat Hunt
// Purpose:
//   Lightweight behavioural hunt for active polymorphic loaders
// ============================================================================

let lookback = 3d;

let writable_paths = dynamic([
  @"C:\Users\",
  @"C:\ProgramData\",
  @"C:\Windows\Temp\"
]);

let lolbins = dynamic([
  "powershell.exe","rundll32.exe","mshta.exe","regsvr32.exe"
]);

DeviceFileEvents
| where Timestamp >= ago(lookback)
| where ActionType == "FileCreated"
| extend Ext = tolower(split(FileName,".")[-1])
| where Ext in ("dll","exe","sys")
| where FolderPath has_any (writable_paths)
| join kind=inner (
    DeviceProcessEvents
    | where Timestamp >= ago(lookback)
    | where FileName in~ (lolbins)
) on DeviceId
| join kind=leftouter (
    DeviceNetworkEvents
    | where Timestamp >= ago(lookback)
    | where ActionType == "ConnectionSuccess"
) on DeviceId
| project
    DeviceName,
    FileName,
    FolderPath,
    InitiatingProcessFileName,
    ProcessCommandLine,
    RemoteIP,
    RemotePort// =====================================================================================================
// HUNT 2 (L2/L2.5): L2_Tight_CorePlus_Polymorphic_Loader_Hunt
// Audience : L2 / L2.5 Threat Hunters
// Goal     : Lower-noise, fast “hot loader” leads using STRONG PID + time correlation.
//            This is intentionally simpler and safer, with prevalence enrichment, not filtering.
// =====================================================================================================

let l2_lookback = 72h;
let CorrelationWindow = 10m;

// --- TUNABLE allowlist toggles
let L2_KnownGoodProcesses = dynamic([
  // Add known benign “builder/updater” parents if needed (keep strict):
  // "msiexec.exe","setup.exe","trusted_updater.exe","msbuild.exe"
]);

let L2_WritablePaths = dynamic([
  @"C:\Users\",
  @"C:\ProgramData\",
  @"C:\Windows\Temp\"
]);

let L2_LOLBins = dynamic([
  "powershell.exe","pwsh.exe","rundll32.exe","mshta.exe","regsvr32.exe","cmd.exe"
]);

let L2_TenantPrev =
DeviceFileEvents
| where Timestamp >= ago(l2_lookback)
| where isnotempty(SHA256)
| summarize TenantDeviceCount = dcount(DeviceId), TenantEventCount=count() by SHA256;

// 1) Drops in writable paths (DLL/EXE/SYS)
let L2_Drops =
DeviceFileEvents
| where Timestamp >= ago(l2_lookback)
| where ActionType == "FileCreated"
| extend Ext = tolower(split(FileName,".")[-1])
| where Ext in ("dll","exe","sys")
| where FolderPath has_any (L2_WritablePaths)
| where InitiatingProcessFileName !in~ (L2_KnownGoodProcesses)
| project
    DeviceId,
    DeviceName,
    DropTime = Timestamp,
    DroppedFileName = FileName,
    DroppedFolderPath = FolderPath,
    DroppedFileExt = Ext,
    DroppedSHA256 = SHA256,
    DropperPid = InitiatingProcessId,
    DropperProc = InitiatingProcessFileName,
    DropperCmd  = InitiatingProcessCommandLine;

// 2) LOLBin execution (same PID OR direct child of dropper PID)
let L2_LOLExec =
DeviceProcessEvents
| where Timestamp >= ago(l2_lookback)
| where ActionType == "ProcessCreated"
| where FileName in~ (L2_LOLBins)
| where InitiatingProcessFileName !in~ (L2_KnownGoodProcesses)
| extend HasEncodedHints = iif(tolower(ProcessCommandLine) has_any (" -enc","encodedcommand","frombase64string","iex ","invoke-expression"), 1, 0)
| extend HasBase64Blob  = iif(ProcessCommandLine matches regex Base64LikeRegex, 1, 0)
| project
    DeviceId,
    LOLTime = Timestamp,
    LOLProc = FileName,
    LOLCmd  = ProcessCommandLine,
    LOLPid  = ProcessId,
    ParentPid = InitiatingProcessId,
    HasEncodedHints,
    HasBase64Blob;

// 3) Optional network enrichment for the LOLBin PID (non-blocking)
let L2_Net =
DeviceNetworkEvents
| where Timestamp >= ago(l2_lookback)
| where ActionType == "ConnectionSuccess"
| project
    DeviceId,
    NetTime = Timestamp,
    ProcessId,
    RemoteUrl,
    RemoteIP,
    RemotePort;

L2_Drops
| join kind=inner (L2_LOLExec) on DeviceId
| where
    (DropperPid == LOLPid) or (DropperPid == ParentPid)
| where LOLTime between (DropTime .. DropTime + CorrelationWindow)
| join kind=leftouter (L2_Net) on DeviceId, $left.LOLPid == $right.ProcessId
| join kind=leftouter (L2_TenantPrev) on $left.DroppedSHA256 == $right.SHA256
| extend
    TenantDeviceCount = coalesce(TenantDeviceCount, 0),
    TenantEventCount  = coalesce(TenantEventCount, 0),
    FastC2 = iif(isnotempty(NetTime) and (NetTime - LOLTime) between (0s..60s), 1, 0),
    SuspiciousPort = iif(RemotePort !in (80,443,53,3389,25,587,993,995) and RemotePort != 0, 1, 0),
    PrevalenceHint =
      case(
        TenantDeviceCount <= 2, "RARE (<=2 devices)",
        TenantDeviceCount between (3..10), "LOW (3–10 devices)",
        TenantDeviceCount >= 50, "COMMON (>=50 devices)",
        "UNKNOWN (no hash)"
      ),
    Triage =
      case(
        FastC2==1 and (HasEncodedHints==1 or HasBase64Blob==1), "HOT (Encoded + FastC2)",
        FastC2==1, "HIGH (FastC2)",
        (HasEncodedHints==1 or HasBase64Blob==1), "MED (Encoded Exec Lead)",
        "LEAD"
      )
| project
    LastSeen = coalesce(NetTime, LOLTime, DropTime),
    DeviceName,
    Triage,
    PrevalenceHint,
    TenantDeviceCount,
    TenantEventCount,
    DropTime,
    DroppedFileName,
    DroppedFolderPath,
    DroppedFileExt,
    DroppedSHA256,
    DropperProc,
    DropperCmd,
    LOLProc,
    LOLCmd,
    HasEncodedHints,
    HasBase64Blob,
    FastC2,
    RemoteUrl,
    RemoteIP,
    RemotePort,
    SuspiciousPort
| order by
    case(Triage startswith "HOT", 4, Triage startswith "HIGH", 3, Triage startswith "MED", 2, 1) desc,
    LastSeen desc
;

// ---------------------------------------------
// IR FRAMEWORK (L2 / L2.5) — Comprehensive (Commented)
// ---------------------------------------------
//
// 1) IDENTIFY (What makes this a real lead)
//    - Drop in writable path + LOLBin execution within 10 minutes (PID-linked: same or direct child).
//    - HOT if: Encoded execution + FastC2 within 60s.
//
// 2) VALIDATE (Fast checks)
//    - Confirm PID linkage (DropperPid == LOLPid OR DropperPid == ParentPid).
//    - Check PrevalenceHint:
//        RARE (<=2) = higher concern; COMMON (>=50) = likely updater/tooling; verify before escalation.
//    - Check commandline intent:
//        -enc / frombase64string / iex / invoke-expression => higher risk.
//    - If FastC2:
//        capture RemoteUrl/RemoteIP/RemotePort and note timing.
//
// 3) ESCALATION CRITERIA (to L3)
//    - Triage == HOT or HIGH
//    - PrevalenceHint == RARE/LOW AND LOLCmd shows encoded or download/execution patterns
//    - SuspiciousPort == 1
//    - Repeat hits across multiple devices in short window
//
// 4) CONTAIN (Only if policy allows + corroboration)
//    - If HOT/HIGH + suspicious destination:
//        - Isolate device (or restrict network).
//        - Block destination (Defender indicators / perimeter).
//
// 5) INVESTIGATE (Scoped pivots)
//    - Pivot on DroppedSHA256 across tenant (last 7–14d).
//    - Pivot on RemoteIP/RemoteUrl across tenant (same timeframe).
//    - Pull process tree around DropperProc and LOLProc; look for additional stages.
//
// 6) ERADICATE / RECOVER (handled by L3 typically)
//    - L2 gathers artifacts + timelines; L3 handles removal/persistence/memory steps.
//
// 7) TUNING (to reduce noise without losing signal)
//    - Add the smallest possible allowlists (KnownGoodProcesses) for verified tooling.
//    - Consider narrowing L2_WritablePaths if you have heavy dev/build usage.
//    - Keep prevalence as triage enrichment; do not hard-filter during hunts.
// =================================================================================================
;

// ------------------------------------------------------------------
// IR FRAMEWORK (L2 / L2.5)
// ------------------------------------------------------------------
// Identify:
//   - LOLBin + writable-path payload
// Investigate:
//   - Check file reputation & path legitimacy
//   - Validate business justification
// Escalate to L3 if:
//   - Network activity observed
//   - Unsigned DLL / SYS
//   - Repeated execution
// ============================================================================
