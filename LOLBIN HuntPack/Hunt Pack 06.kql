// ============================================================================
// HUNT PACK 06/10 (UPDATED) â€” Ransomware-Adjacent Defense Evasion (Recovery Inhibition / Log Tamper)
// Binaries: vssadmin.exe, wevtutil.exe, bcdedit.exe, wbadmin.exe, fsutil.exe, cipher.exe, netsh.exe
// Fixes:
//   - Adds wevtutil "cl" clear-log + other high-signal log tamper verbs
//   - Adds legacy bcedit.exe as alias in case it appears (your list)
// ============================================================================

let lookback = 7d;

let TargetProcs = dynamic(["vssadmin.exe","wevtutil.exe","bcdedit.exe","bcedit.exe","wbadmin.exe","fsutil.exe","cipher.exe","netsh.exe"]);
let SuspiciousParents = dynamic(["cmd.exe","powershell.exe","pwsh.exe","wscript.exe","cscript.exe","winword.exe","excel.exe","outlook.exe","mshta.exe"]);
let SuspiciousDirs = dynamic(["\\Users\\Public","\\ProgramData","\\Windows\\Temp","\\Temp","\\Downloads","\\AppData\\Local\\Temp","\\AppData\\Roaming"]);

DeviceProcessEvents
| where TimeGenerated > ago(lookback)
| where FileName in~ (TargetProcs)
| where ProcessCommandLine has_any (
    // VSS deletion (recovery inhibition)
    "delete shadows","delete shadowcopies","shadows /all","/quiet",

    // Event log tamper (HIGH fidelity)
    " wevtutil cl "," wevtutil.exe cl ","clear-log"," sl "," set-log ",

    // Boot/security tampering
    "bcdedit","bcedit","set","bootstatuspolicy","recoveryenabled","safeboot","nointegritychecks",

    // Backup deletion
    "wbadmin delete","catalog","systemstatebackup",

    // FS/attr tamper / wipe
    "fsutil","usn","deletejournal","setzerodata","behavior set",
    "cipher /w",

    // Firewall/network tamper
    "netsh advfirewall","firewall set","set allprofiles state off"
)
| extend
    HasNet = ProcessCommandLine matches regex @"(?i)(http[s]?://|ftp://)",
    HasScript = ProcessCommandLine has_any ("-enc","frombase64string","iex"),
    BadDLLPath = ProcessCommandLine has ".dll" and ProcessCommandLine has_any (SuspiciousDirs),
    WeirdExport = bool(false),
    BadParent = InitiatingProcessFileName in~ (SuspiciousParents),
    IsDownloader = bool(false),
    IsPersistence = (FileName in~ ("bcdedit.exe","bcedit.exe") and ProcessCommandLine has " set ")
| extend RiskScore =
    0
    + iif(HasNet or IsDownloader, 60, 0)
    + iif(HasScript, 50, 0)
    + iif(BadDLLPath, 30, 0)
    + iif(WeirdExport, 20, 0)
    + iif(BadParent, 20, 0)
    + iif(IsPersistence, 40, 0)
    + iif(FileName =~ "wevtutil.exe" and ProcessCommandLine has " cl ", 60, 0)
    + iif(FileName =~ "vssadmin.exe" and ProcessCommandLine has "delete", 60, 0)
| where RiskScore >= 50
| extend Hunter_Directive = case(
    FileName =~ "vssadmin.exe", "CRITICAL: Shadow copy deletion (ransomware recovery inhibition)",
    FileName =~ "wevtutil.exe" and ProcessCommandLine has " cl ", "CRITICAL: Event log cleared via wevtutil (anti-forensics)",
    FileName in~ ("bcdedit.exe","bcedit.exe"), "HIGH: Boot/security configuration tamper",
    FileName =~ "wbadmin.exe", "HIGH: Backup deletion / recovery inhibition",
    FileName =~ "netsh.exe", "HIGH: Firewall/network tamper",
    "HIGH: Defense evasion / recovery inhibition via LOLBIN"
)
| summarize Count=count(), MaxRisk=max(RiskScore), SampleCLI=any(ProcessCommandLine)
    by DeviceName, FileName, Hunter_Directive
| where not(Count > 20 and MaxRisk < 70)
