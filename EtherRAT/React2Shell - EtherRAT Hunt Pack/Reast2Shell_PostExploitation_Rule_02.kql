// ============================================================================
// L3_ReactDevServer_PostExploitation_Chain — ANALYTIC MODE (Alert-Safe)
// Author: Ala Dabat
// Version: 2025-12 (L3 Analytic)
// Platforms: Windows + Linux (MDE Advanced Hunting / Sentinel Analytic)
// Purpose:
//   Production-ready analytic with tenant-toggle allowlisting to reduce FPs.
//   Alerts on high-confidence post-exploitation chains from web/runtime parents.
//
// Design Note (Truth in Telemetry):
//   In-memory exploitation (HMR/eval/vm.runInThisContext) is not reliably visible.
//   This analytic detects *post-exploitation side-effects* (proc/net/file).
// ============================================================================

let lookback = 7d;
let ChainWindow = 10m;

let EnableAllowlist = true;

let AllowedParentCmdlinePatterns = dynamic([
  "npm install","npm ci","npm run build",
  "yarn install","yarn build",
  "pnpm install","pnpm build",
  "webpack","vite","react-scripts","next build",
  "gulp","grunt"
]);

let AllowedPaths = dynamic([
  "\\agent\\_work\\",
  "\\actions\\runner\\",
  "/home/runner/",
  "/opt/hostedtoolcache/",
  "/var/lib/jenkins/",
  "/build/",
  "/workspace/"
]);

let AllowedAccounts = dynamic([
  "svc-azure-devops",
  "svc-github-runner",
  "svc-jenkins",
  "buildagent",
  "runner"
]);

let ParentProc = dynamic([
  "node.exe","node",
  "w3wp.exe","iisexpress.exe",
  "httpd.exe","nginx.exe",
  "java.exe","java",
  "dotnet.exe","dotnet",
  "gunicorn","uwsgi"
]);

let ChildProc = dynamic([
  "powershell.exe","pwsh.exe","cmd.exe",
  "mshta.exe","wscript.exe","cscript.exe",
  "rundll32.exe","regsvr32.exe","certutil.exe",
  "msbuild.exe","csc.exe","installutil.exe","msiexec.exe",
  "sh","bash","dash","zsh",
  "python","python3","perl","php","ruby",
  "curl","wget","nc","ncat","socat","ssh"
]);

let StagingSignals = dynamic([
  "Invoke-Expression","IEX","Invoke-WebRequest","EncodedCommand","FromBase64String",
  "AmsiScanBuffer","AmsiUtils","System.Management.Automation",
  "curl http","wget http","curl|bash","curl | bash","wget -O - | bash",
  "bash -c","sh -c",
  "child_process.exec","child_process.spawn","vm.runInThisContext","eval("
]);

let SensitiveFileHints = dynamic([
  ".env",".npmrc",".aws/credentials",".ssh/id_rsa","config.json","id_rsa","known_hosts",
  ".bashrc",".zshrc",".profile"
]);

let MaliciousExtensions = dynamic([
  ".ps1",".bat",".cmd",".vbs",".js",".jse",".sh",".py",".pl",".php",".jar",".jsp",
  ".exe",".dll",".so"
]);

let IsAllowlistedProc =
  EnableAllowlist
  and (InitiatingProcessCommandLine has_any (AllowedParentCmdlinePatterns) or AccountName has_any (AllowedAccounts));

let IsAllowlistedFile =
  EnableAllowlist
  and (InitiatingProcessCommandLine has_any (AllowedParentCmdlinePatterns) or AccountName has_any (AllowedAccounts) or FolderPath has_any (AllowedPaths));

let Proc =
DeviceProcessEvents
| where Timestamp >= ago(lookback)
| where InitiatingProcessFileName has_any (ParentProc)
| where FileName has_any (ChildProc)
| where not(IsAllowlistedProc)
| extend Cmd = tostring(ProcessCommandLine)
| extend HasStaging = Cmd has_any (StagingSignals)
| extend HasPipeToShell = Cmd matches regex @"(curl\s+\S+.*\|\s*(ba|z|da)?sh)|(wget\s+.+\|\s*(ba|z|da)?sh)"
| extend B64 = extract_all(@"[A-Za-z0-9+/]{40,}={0,2}", Cmd)
| extend HasB64 = array_length(B64) > 0
| extend ProcScore =
    40
  + iif(HasStaging, 30, 0)
  + iif(HasPipeToShell, 45, 0)
  + iif(HasB64, 15, 0)
| where ProcScore >= 60
| project ProcTs=Timestamp, DeviceId, DeviceName, AccountName,
          Parent=InitiatingProcessFileName, ParentCmd=InitiatingProcessCommandLine,
          Child=FileName, Cmd, ProcScore, HasStaging, HasPipeToShell, HasB64;

let Net =
DeviceNetworkEvents
| where Timestamp >= ago(lookback)
| where InitiatingProcessFileName has_any (ParentProc)
| where ActionType in ("ConnectionSuccess","InboundConnectionAccepted","ListeningConnectionCreated")
| extend Remote = coalesce(RemoteUrl, RemoteIP)
| extend RemoteUrlIndicators = RemoteUrl has_any (dynamic(["pastebin","discord","telegram","ngrok","trycloudflare","onion"]))
| extend RemoteIpNonPrivate = iff(isnotempty(RemoteIP), not(ipv4_is_private(RemoteIP)), bool(null))
| extend HighRiskPort = RemotePort in (4444, 1337, 2222, 3001, 4443, 8080, 8443, 9001, 31337)
| extend NetScore =
    20
  + iif(RemoteUrlIndicators, 20, 0)
  + iif(HighRiskPort and RemoteIpNonPrivate == true, 35, 0)
| project NetTs=Timestamp, DeviceId, DeviceName, AccountName,
          Parent=InitiatingProcessFileName, ParentCmd=InitiatingProcessCommandLine,
          RemoteIP, RemotePort, RemoteUrl, LocalPort, Protocol, ActionType, NetScore;

let Files =
DeviceFileEvents
| where Timestamp >= ago(lookback)
| where InitiatingProcessFileName has_any (ParentProc)
| where ActionType in ("FileCreated","FileModified","FileRenamed")
| where not(IsAllowlistedFile)
| extend Path = tostring(FolderPath)
| extend Name = tostring(FileName)
| extend HasSensitiveName = Name has_any (SensitiveFileHints)
| extend HasMaliciousExt = Name has_any (MaliciousExtensions)
| extend HasTempOrHidden =
    Path has_any (dynamic(["\\Temp\\","\\AppData\\Local\\Temp\\","/tmp/","/var/tmp/","/.cache/"]))
    or Name startswith "."
| extend FileScore =
    10
  + iif(HasSensitiveName, 55, 0)
  + iif(HasMaliciousExt and HasTempOrHidden, 35, 0)
| project FileTs=Timestamp, DeviceId, DeviceName, AccountName,
          Parent=InitiatingProcessFileName, ParentCmd=InitiatingProcessCommandLine,
          FolderPath, FileName, FileScore, HasSensitiveName, HasTempOrHidden, HasMaliciousExt;

Proc
| join kind=leftouter (Net) on DeviceId, AccountName, Parent
| where NetTs between (ProcTs - ChainWindow .. ProcTs + ChainWindow) or isempty(NetTs)
| join kind=leftouter (Files) on DeviceId, AccountName, Parent
| where FileTs between (ProcTs - ChainWindow .. ProcTs + ChainWindow) or isempty(FileTs)
| extend TotalScore = ProcScore + coalesce(NetScore,0) + coalesce(FileScore,0)
| extend ChainBucket = bin(ProcTs, ChainWindow)
| summarize
    FirstSeen=min(ProcTs),
    LastSeen=max(ProcTs),
    Parents=make_set(Parent, 5),
    ParentCmds=make_set(ParentCmd, 10),
    Children=make_set(Child, 25),
    CommandLines=make_set(Cmd, 25),
    Remotes=make_set(coalesce(RemoteUrl, RemoteIP), 25),
    RemotePorts=make_set(tostring(RemotePort), 25),
    FileTouches=make_set(strcat(FolderPath,"\\",FileName), 25),
    MaxScore=max(TotalScore),
    Signals=make_set(
      strcat(
        iif(HasStaging,"Staging;",""),
        iif(HasPipeToShell,"PipeToShell;",""),
        iif(HasB64,"Base64;",""),
        iif(HasSensitiveName,"SensitiveFileName;",""),
        iif(HasTempOrHidden,"TempOrHiddenWrite;",""),
        iif(HasMaliciousExt,"MaliciousExtensionWrite;","")
      ), 10
    )
  by ChainBucket, DeviceName, AccountName
| extend Severity = case(
    MaxScore >= 115, "CRITICAL",
    MaxScore >= 85,  "HIGH",
    MaxScore >= 55,  "MEDIUM",
    "LOW"
)
| where Severity in ("CRITICAL","HIGH","MEDIUM")
| extend HuntingDirectives = case(
    Severity == "CRITICAL",
      "CRITICAL: Treat as likely compromise. Validate runtime parent + child shell/LOLBins + confirm external C2/exfil or sensitive file touches. Recommend isolate host, scope blast radius, rotate secrets.",
    Severity == "HIGH",
      "HIGH: Confirm not allowlisted CI/dev tooling. Pivot to persistence (cron/systemd/services/tasks), check secrets access (.env/.ssh), and review outbound connections. Escalate if corroborated.",
    "MEDIUM: Needs corroboration. Validate expected dev/build activity for tenant; pivot to net/file evidence. If repeated chains or external high-risk ports present, escalate."
)
| order by FirstSeen desc
;

// ============================================================================
// INCIDENT RESPONSE FRAMEWORK — React / Node.js Runtime Post-Exploitation
// ============================================================================
// Same phases as hunt mode; enforce allowlists and threshold tuning per tenant.
// ============================================================================
