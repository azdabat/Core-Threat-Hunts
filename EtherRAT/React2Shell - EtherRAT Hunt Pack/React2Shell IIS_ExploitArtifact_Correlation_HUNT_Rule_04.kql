// ============================================================================
// L3_IIS_ExploitArtifact_Correlation_HUNT (ViewState/ASP.NET artifacts → delayed w3wp abuse)
// Author: Ala Dabat
// Version: 2025-12 (L3 Hunt)
// Platform: Windows (IIS / ASP.NET) + Sentinel/MDE correlation
//
// PURPOSE:
//   Catch fileless exploitation that stays inside w3wp.exe by correlating:
//     A) Exploit-like IIS/ASP.NET artifacts (ViewState/deserialization indicators, app errors)
//     B) Follow-on *first-seen* or rare w3wp.exe external network behavior (hours/days later)
//     C) Optional: suspicious file writes by w3wp.exe outside typical web content roots
//
// WHY THIS MATTERS:
//   Advanced adversaries may exploit now and act later. EDR can't see the exploit itself,
//   but the environment often logs "something broke" at exploit time (IIS/ASP.NET errors).
//
// DATA NOTES:
//   - Replace the "Event" query with your environment's IIS/ASP.NET telemetry source.
//   - If you don't ingest Windows Application logs, this hunt will not work as intended.
// ============================================================================

let lookback = 14d;          // longer horizon to catch low-and-slow
let PivotAfterArtifact = 7d; // window after exploit artifact to look for follow-on
let FirstSeenLookback = 30d; // baseline for "first-ever" w3wp external destinations

// ----------------------------
// A) EXPLOIT-ARTIFACT SIGNALS (Windows Application logs / ASP.NET / IIS)
// ----------------------------
// Replace/extend patterns as your log source allows.
// Common artifact themes:
//   - ViewState validation/MAC failures
//   - ASP.NET unhandled exceptions
//   - Serialization/deserialization errors
//   - Request validation errors
//
// Sentinel classic tables:
//   - Event (Windows event logs via AMA/legacy agents)
//   - SecurityEvent (not usually Application logs)
// If your environment uses a custom table, swap it here.
let ExploitArtifacts =
Event
| where TimeGenerated >= ago(lookback)
| where EventLog =~ "Application"
| extend Msg = tostring(RenderedDescription)
| extend Provider = tostring(Source)
| extend EID = toint(EventID)
| where
    // Broad, hunt-safe patterns; tune per tenant
    Msg has_any ("ViewState","MAC validation","validation of viewstate","deserialization","serialization","LosFormatter","MachineKey","RequestValidation","Unhandled Exception","System.Web","Invalid viewstate")
    or Provider has_any ("ASP.NET","IIS AspNetCore Module","Application Error")
| project ArtifactTime=TimeGenerated, Computer=tostring(Computer), EID, Provider, Msg;

// ----------------------------
// B) FOLLOW-ON: w3wp.exe EXTERNAL NETWORK (first-seen / rare destinations)
// ----------------------------
let W3wpExternalNet =
DeviceNetworkEvents
| where Timestamp >= ago(lookback)
| where InitiatingProcessFileName =~ "w3wp.exe"
| where ActionType == "ConnectionSuccess"
| extend IsExternal = iff(isnotempty(RemoteIP), not(ipv4_is_private(RemoteIP)), bool(null))
| where IsExternal == true
| extend Remote = coalesce(RemoteUrl, RemoteIP)
| project NetTime=Timestamp, DeviceName, DeviceId, AccountName,
          Remote, RemoteIP, RemoteUrl, RemotePort, Protocol, LocalPort;

// Baseline: what has this device seen over the last 30 days?
let W3wpBaseline =
DeviceNetworkEvents
| where Timestamp >= ago(FirstSeenLookback)
| where InitiatingProcessFileName =~ "w3wp.exe"
| where ActionType == "ConnectionSuccess"
| extend IsExternal = iff(isnotempty(RemoteIP), not(ipv4_is_private(RemoteIP)), bool(null))
| where IsExternal == true
| extend Remote = coalesce(RemoteUrl, RemoteIP)
| summarize BaselineFirstSeen=min(Timestamp), BaselineCount=count() by DeviceName, Remote;

// Mark “first-seen/rare” remotes during the lookback
let W3wpRareRemotes =
W3wpExternalNet
| join kind=leftouter (W3wpBaseline) on DeviceName, Remote
| extend IsFirstSeen = iif(isempty(BaselineFirstSeen) or BaselineFirstSeen > ago(lookback), 1, 0)
| extend IsRare = iif(coalesce(BaselineCount,0) < 3, 1, 0)
| where IsFirstSeen == 1 or IsRare == 1
| project NetTime, DeviceName, DeviceId, AccountName, Remote, RemoteIP, RemoteUrl, RemotePort, Protocol, LocalPort, IsFirstSeen, IsRare, BaselineCount;

// ----------------------------
// C) OPTIONAL: w3wp.exe SUSPICIOUS WRITES OUTSIDE TYPICAL WEB ROOTS
// ----------------------------
let SuspiciousWritePaths = dynamic([
  "\\users\\public\\",
  "\\windows\\temp\\",
  "\\programdata\\",
  "\\windows\\system32\\tasks\\"
]);

let W3wpWrites =
DeviceFileEvents
| where Timestamp >= ago(lookback)
| where InitiatingProcessFileName =~ "w3wp.exe"
| where ActionType in ("FileCreated","FileModified","FileRenamed")
| where FolderPath has_any (SuspiciousWritePaths)
| project FileTime=Timestamp, DeviceName, DeviceId, AccountName, FolderPath, FileName;

// ----------------------------
// CORRELATION: exploit artifacts → follow-on rare external remotes → optional writes
// ----------------------------
// Key join dimension: Computer/DeviceName mapping.
// If your Event.Computer naming differs from DeviceName, normalize here.
ExploitArtifacts
| extend DeviceName = Computer
| join kind=leftouter (W3wpRareRemotes) on DeviceName
| where NetTime between (ArtifactTime .. ArtifactTime + PivotAfterArtifact) or isempty(NetTime)
| join kind=leftouter (W3wpWrites) on DeviceName
| where FileTime between (ArtifactTime .. ArtifactTime + PivotAfterArtifact) or isempty(FileTime)
| extend HasRareNet = iif(isnotempty(NetTime), 1, 0)
| extend HasSuspWrite = iif(isnotempty(FileTime), 1, 0)
| extend RiskScore =
    30  // exploit artifact present
  + iif(HasRareNet==1, 40, 0)
  + iif(HasSuspWrite==1, 30, 0)
| extend Severity = case(
    RiskScore >= 90, "CRITICAL",
    RiskScore >= 70, "HIGH",
    RiskScore >= 50, "MEDIUM",
    "LOW"
)
| where Severity in ("CRITICAL","HIGH","MEDIUM")
| summarize
    FirstArtifact=min(ArtifactTime),
    LastArtifact=max(ArtifactTime),
    ArtifactEventIds=make_set(tostring(EID), 10),
    Providers=make_set(Provider, 10),
    ArtifactSamples=make_set(substring(Msg, 0, 180), 10),
    FirstNet=min(NetTime),
    Remotes=make_set(Remote, 20),
    RemotePorts=make_set(tostring(RemotePort), 20),
    FirstWrite=min(FileTime),
    Writes=make_set(strcat(FolderPath,"\\",FileName), 20),
    MaxScore=max(RiskScore)
  by DeviceName, AccountName
| extend Severity = case(
    MaxScore >= 90, "CRITICAL",
    MaxScore >= 70, "HIGH",
    "MEDIUM"
)
| extend HuntingDirectives = case(
    Severity=="CRITICAL",
      "CRITICAL: IIS/ASP.NET exploit-like artifacts followed by first-seen/rare external comms by w3wp.exe (and/or suspicious writes). Treat as likely fileless compromise. Pivot to w3wp.exe timeline, memory capture, IIS logs, and containment.",
    Severity=="HIGH",
      "HIGH: Exploit artifacts with corroborating w3wp.exe abnormal outbound or suspicious writes. Validate if remotes are expected SaaS; if not, escalate and scope for persistence and credential access.",
    "MEDIUM: Exploit artifacts with weak corroboration. Baseline error frequency; hunt for repeated artifacts and any later w3wp external remotes."
)
| order by FirstArtifact desc;

// ============================================================================
// INCIDENT RESPONSE FRAMEWORK — IIS Exploit-Artifact Correlation
// ============================================================================
// 1) TRIAGE
//    - Confirm artifact source (EventLog/Application) and message theme (ViewState/deserialization).
//    - Validate whether errors are unusual for this host/app.
// 2) SCOPE
//    - Pivot to w3wp.exe network: first-seen remotes, new user agents (if proxy logs exist), frequency.
//    - Review IIS logs around FirstArtifact for anomalous requests/parameters, large __VIEWSTATE, etc.
// 3) CONTAIN
//    - If CRITICAL/HIGH: isolate host or remove public exposure; recycle/stop app pool.
// 4) ERADICATE
//    - Rotate machine keys / app secrets; patch vulnerable components; remove persistence if found.
// 5) HARDEN
//    - Enforce ViewState MAC + encryption; WAF rules; least-privilege app pools; monitoring.
// ============================================================================
